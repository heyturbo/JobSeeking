<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bransonè€å¸ˆå‘è¨€å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        supportive: {
                            light: '#10B981',
                            dark: '#059669'
                        },
                        neutral: {
                            light: '#3B82F6',
                            dark: '#2563EB'
                        },
                        cautionary: {
                            light: '#F59E0B',
                            dark: '#D97706'
                        },
                        comfort: {
                            light: '#EC4899',
                            dark: '#DB2777'
                        },
                        warning: {
                            light: '#EF4444',
                            dark: '#DC2626'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'typewriter': 'typewriter 0.1s linear',
                    },
                    keyframes: {
                        typewriter: {
                            'from': { opacity: '0.7' },
                            'to': { opacity: '1' }
                        }
                    }
                }
            }
        }
        
        // æ£€æµ‹æš—é»‘æ¨¡å¼
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>

        
        .tab-button {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tab-button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #5D5CDE;
            transition: width 0.3s ease;
        }
        
        .tab-button.active::after {
            width: 100%;
        }
        
        .tab-button:hover:not(.active)::after {
            width: 50%;
        }
        
        .drop-zone {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .drop-zone.drag-over {
            background-color: rgba(93, 92, 222, 0.1);
            border-color: #5D5CDE;
            transform: scale(1.02);
        }
        
        .drop-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px dashed transparent;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .drop-zone.drag-over::before {
            border-color: #6366F1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(236, 72, 153, 0.05));
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #6366F1;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .file-item {
            transition: all 0.2s ease;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(236, 72, 153, 0.05));
        }
        
        .file-item:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
            transform: translateY(-1px);
        }
        
        .conversation-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .conversation-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-panel {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .result-panel.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.8);
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .dark .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .two-column-layout {
                flex-direction: column;
            }
            
            .column {
                width: 100% !important;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- å¤´éƒ¨ -->
        <header class="text-center mb-8">
            <div class="glass-effect rounded-2xl p-6 card-shadow">
                <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3">
                    âœ¨ Bransonè€å¸ˆå‘è¨€å™¨
                </h1>
                <p class="text-gray-700 dark:text-gray-300 text-lg">åŸºäºçœŸå®è¯­æ–™ï¼Œæ™ºèƒ½æ¨¡æ‹ŸBransonè€å¸ˆçš„å›å¤é£æ ¼</p>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒº - ä¸¤åˆ—å¸ƒå±€ -->
        <div class="two-column-layout flex gap-6">
            <!-- å·¦åˆ—ï¼šé—®é¢˜è¾“å…¥åŒº -->
            <div class="column w-1/2">
                <div class="glass-effect rounded-2xl p-6 card-shadow h-fit">
                    <!-- æ¨¡å¼åˆ‡æ¢æ ‡ç­¾ -->
                    <div class="mb-6">
                        <div class="flex border-b-2 border-gray-200 dark:border-gray-700">
                            <button id="responseBtn" class="px-6 py-3 font-semibold text-primary border-b-3 border-primary tab-button active">
                                ğŸ“ å›åº”æ¨¡å¼
                            </button>
                            <button id="refineBtn" class="px-6 py-3 font-semibold text-gray-500 dark:text-gray-400 tab-button">
                                âœ¨ æ¶¦è‰²æ¨¡å¼
                            </button>
                        </div>
                    </div>

                    <!-- å›åº”æ¨¡å¼ -->
                    <div id="responseMode">
                        <!-- åŸºç¡€é—®é¢˜è¾“å…¥ -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold mb-3 text-gray-700 dark:text-gray-300">
                                ğŸ’¬ éœ€è¦å›åº”çš„ä¿¡æ¯
                            </label>
                            <textarea 
                                id="responseInput" 
                                class="w-full px-4 py-3 text-base border-2 border-purple-200 dark:border-purple-700 rounded-xl dark:bg-gray-800 min-h-[120px] focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" 
                                placeholder="è¾“å…¥éœ€è¦Bransonè€å¸ˆå›åº”çš„å†…å®¹..."
                            ></textarea>
                        </div>
                        

                        
                        <!-- ç«‹åœºé€‰æ‹© -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-3 text-gray-700 dark:text-gray-300">
                                ç«‹åœºé€‰æ‹©
                            </label>
                            <div class="grid grid-cols-2 gap-2 md:grid-cols-3">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="stance" value="supportive" class="form-radio text-primary">
                                    <span class="ml-2 text-sm">æ”¯æŒ</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="stance" value="neutral" class="form-radio text-primary" checked>
                                    <span class="ml-2 text-sm">ä¸­ç«‹</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="stance" value="opposed" class="form-radio text-primary">
                                    <span class="ml-2 text-sm">åå¯¹</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="stance" value="comfort" class="form-radio text-primary">
                                    <span class="ml-2 text-sm">å®‰æŠš</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="stance" value="warning" class="form-radio text-primary">
                                    <span class="ml-2 text-sm">è­¦ç¤º</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="stance" value="multiple" class="form-radio text-primary">
                                    <span class="ml-2 text-sm">å¤šç‰ˆæœ¬</span>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 bg-gray-50 dark:bg-gray-800 p-2 rounded-lg">
                                é€‰æ‹©Bransonè€å¸ˆçš„å›åº”ç«‹åœºã€‚"å¤šç‰ˆæœ¬"å°†ç”Ÿæˆæ”¯æŒã€ä¸­ç«‹ã€åå¯¹ä¸‰ç§ç«‹åœºçš„å›å¤
                            </p>
                        </div>

                        <!-- è¿½é—®åŠŸèƒ½åŒº -->
                        <div class="mb-6">
                            <div class="bg-gradient-to-r from-emerald-50 to-blue-50 dark:from-emerald-900/20 dark:to-blue-900/20 rounded-xl p-4 border border-emerald-200 dark:border-emerald-700">
                                <label class="block text-sm font-semibold mb-3 text-emerald-700 dark:text-emerald-300">
                                    ğŸ”„ è¿½é—®å›åº”ï¼ˆåŸºäºå‰æ–‡å¯¹è¯ï¼‰
                                </label>
                                
                                <!-- å¯¹è¯å†å²æ˜¾ç¤º -->
                                <div class="mb-4">
                                    <div class="text-xs text-emerald-600 dark:text-emerald-400 mb-2 font-medium">å¯¹è¯å†å²ï¼š</div>
                                    <div id="conversationHistory" class="conversation-history border rounded-lg p-3 bg-white/50 dark:bg-gray-800/50 max-h-40 overflow-y-auto">
                                        <p class="text-gray-500 dark:text-gray-400 text-center text-sm">æš‚æ— å¯¹è¯å†å²</p>
                                    </div>
                                </div>
                                
                                <!-- è¿½é—®è¾“å…¥ -->
                                <textarea 
                                    id="followUpInput" 
                                    class="w-full px-3 py-2 text-base border border-emerald-300 dark:border-emerald-700 rounded-lg dark:bg-gray-800/50 min-h-[80px] focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all" 
                                    placeholder="è¯·å…ˆè¾“å…¥ä¸Šæ–¹çš„"éœ€è¦å›åº”çš„ä¿¡æ¯"ï¼Œç„¶ååœ¨æ­¤è¾“å…¥è¿½é—®å†…å®¹..."
                                    disabled
                                ></textarea>
                                
                                <!-- è¿½é—®æŒ‰é’® -->
                                <div class="mt-3">
                                    <button id="followUpBtn" class="w-full px-4 py-2 text-white bg-emerald-500 hover:bg-emerald-600 rounded-lg font-medium shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <span class="flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.003 8.003 0 01-7.799-6.666c-.31-1.59-.31-3.374 0-4.968A8.003 8.003 0 0113 4c4.418 0 8 3.582 8 8z" />
                                            </svg>
                                            å›åº”è¿½é—®
                                        </span>
                                    </button>
                                </div>
                                
                                <p class="text-xs text-emerald-600 dark:text-emerald-400 mt-2">
                                    âš¡ è¿½é—®ä¼šç»“åˆå‰æ–‡å¯¹è¯æä¾›æ›´æœ‰é’ˆå¯¹æ€§çš„å›åº”
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- æ¶¦è‰²æ¨¡å¼ -->
                    <div id="refineMode" class="hidden">
                        <div class="mb-6">
                            <label class="block text-sm font-semibold mb-3 text-gray-700 dark:text-gray-300">
                                âœ¨ éœ€è¦æ¶¦è‰²çš„æ–‡æœ¬
                            </label>
                            <textarea 
                                id="refineInput" 
                                class="w-full px-4 py-3 text-base border-2 border-purple-200 dark:border-purple-700 rounded-xl dark:bg-gray-800 min-h-[120px] focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" 
                                placeholder="è¾“å…¥éœ€è¦è½¬æ¢ä¸ºBransonè€å¸ˆé£æ ¼çš„æ–‡æœ¬..."
                            ></textarea>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-4 border border-purple-200 dark:border-purple-700">
                            <p class="text-sm text-purple-700 dark:text-purple-300">
                                âœ¨ æ¶¦è‰²åŠŸèƒ½ä¼šå°†æ‚¨çš„æ–‡æœ¬è½¬æ¢ä¸ºBransonè€å¸ˆçš„ä¸“ä¸šè¡¨è¾¾é£æ ¼ï¼Œä¿æŒåŸæ„çš„åŒæ—¶ä¼˜åŒ–è¯­è¨€è¡¨è¾¾ã€‚
                            </p>
                        </div>
                    </div>

                    <!-- ç”ŸæˆæŒ‰é’® -->
                    <div class="flex justify-center mt-8" style="display: flex;justify-content: space-between;">
                        <button id="generateBtn" class="px-8 py-4 text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-xl font-semibold shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <span class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                ç”ŸæˆBransonè€å¸ˆå›å¤
                            </span>
                        </button>
                        <button id="resetBtn" class="px-8 py-4 text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-xl font-semibold shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <span class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                æ¸…ç©º
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³åˆ—ï¼šå›å¤æ˜¾ç¤ºåŒº -->
            <div class="column w-1/2">
                <div class="glass-effect rounded-2xl p-6 card-shadow">
                    <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="resultContainer" class="hidden">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-blue-400 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white font-bold text-lg">B</span>
                            </div>
                            <h3 class="font-bold text-xl text-gray-800 dark:text-gray-200" id="resultTitle">Bransonè€å¸ˆçš„å›å¤</h3>
                        </div>
                        
                        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                        <div id="loadingIndicator" class="flex flex-col items-center justify-center py-12 hidden">
                            <div class="relative">
                                <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-200"></div>
                                <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent absolute top-0"></div>
                            </div>
                            <span class="mt-4 text-gray-600 dark:text-gray-400 font-medium" id="loadingText">æ­£åœ¨ç”Ÿæˆå›å¤...</span>
                        </div>
                        
                        <!-- å•ä¸€å›å¤ç»“æœåŒºåŸŸ -->
                        <div id="singleResultPanel" class="hidden">
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-700">
                                <div id="singleOutput" class="prose dark:prose-invert max-w-none"></div>
                            </div>
                        </div>
                        
                        <!-- å¤šç‰ˆæœ¬å›å¤ç»“æœåŒºåŸŸ -->
                        <div id="resultTabs" class="hidden">
                            <div class="flex flex-wrap border-b-2 border-gray-200 dark:border-gray-700 mb-4">
                                <button id="supportiveTab" class="px-4 py-2 font-semibold text-emerald-600 border-b-3 border-emerald-500 rounded-t-lg transition-all tab-button active">
                                    ğŸ’š æ”¯æŒä¼˜å…ˆ
                                </button>
                                <button id="neutralTab" class="px-4 py-2 font-semibold text-gray-500 dark:text-gray-400 rounded-t-lg transition-all tab-button">
                                    âš–ï¸ ä¸­ç«‹å¸®åŠ©
                                </button>
                                <button id="cautionaryTab" class="px-4 py-2 font-semibold text-gray-500 dark:text-gray-400 rounded-t-lg transition-all tab-button">
                                    âš ï¸ è°¨æ…å»ºè®®
                                </button>
                            </div>
                            
                            <div class="result-panels">
                                <div id="supportivePanel" class="result-panel active">
                                    <div class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 p-4 rounded-xl mb-4 border border-emerald-200 dark:border-emerald-700">
                                        <p class="text-sm text-emerald-700 dark:text-emerald-300 font-medium">ğŸ’š ç§¯ææ”¯æŒç”¨æˆ·çš„æƒ³æ³•å’Œè®¡åˆ’ï¼Œä¾§é‡é¼“åŠ±å’Œè‚¯å®š</p>
                                    </div>
                                    <div id="supportiveOutput" class="prose dark:prose-invert max-w-none"></div>
                                </div>
                                
                                <div id="neutralPanel" class="result-panel hidden">
                                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 p-4 rounded-xl mb-4 border border-blue-200 dark:border-blue-700">
                                        <p class="text-sm text-blue-700 dark:text-blue-300 font-medium">âš–ï¸ æä¾›ä¸­ç«‹å®¢è§‚çš„è§‚ç‚¹å’Œå®ç”¨å»ºè®®</p>
                                    </div>
                                    <div id="neutralOutput" class="prose dark:prose-invert max-w-none"></div>
                                </div>
                                
                                <div id="cautionaryPanel" class="result-panel hidden">
                                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 p-4 rounded-xl mb-4 border border-amber-200 dark:border-amber-700">
                                        <p class="text-sm text-amber-700 dark:text-amber-300 font-medium">âš ï¸ æŒ‡å‡ºæ½œåœ¨é—®é¢˜å’Œéœ€è¦æ³¨æ„çš„äº‹é¡¹</p>
                                    </div>
                                    <div id="cautionaryOutput" class="prose dark:prose-invert max-w-none"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¿å­˜åˆ°å¯¹è¯å†å²æŒ‰é’® -->
                        <div id="saveToHistoryBtn" class="mt-6 hidden">
                            <button class="w-full px-4 py-3 bg-gradient-to-r from-emerald-500 to-blue-500 text-white rounded-xl hover:from-emerald-600 hover:to-blue-600 transition-all font-medium">
                                ğŸ’¾ ä¿å­˜åˆ°å¯¹è¯å†å²
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="emptyState" class="text-center py-16">
                        <div class="w-24 h-24 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.003 8.003 0 01-7.799-6.666c-.31-1.59-.31-3.374 0-4.968A8.003 8.003 0 0113 4c4.418 0 8 3.582 8 8z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-600 dark:text-gray-400 mb-2">ç­‰å¾…æ‚¨çš„é—®é¢˜</h3>
                        <p class="text-gray-500 dark:text-gray-500">åœ¨å·¦ä¾§è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒBransonè€å¸ˆä¼šä¸ºæ‚¨æä¾›ä¸“ä¸šå›å¤</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <footer class="text-center mt-8">
            <div class="glass-effect rounded-xl p-4">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    ğŸ¤– åŸºäºBransonè€å¸ˆçš„çœŸå®è¯­æ–™ï¼Œé€šè¿‡AIæŠ€æœ¯ç”Ÿæˆç›¸ä¼¼é£æ ¼çš„å›å¤
                </p>
            </div>
        </footer>
    </div>

    <script>

        // Domæš‚å­˜é…ç½®
        const FileUploadingArea = `                        
                    <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold mb-3 text-gray-700 dark:text-gray-300">
                                ğŸ“ æˆ–ä¸Šä¼ æ–‡ä»¶
                            </label>
                            <div id="dropZone" class="drop-zone border-2 border-dashed border-purple-300 dark:border-purple-700 rounded-xl p-6 text-center cursor-pointer">
                                <div class="flex flex-col items-center">
                                    <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                    </div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-2 font-medium">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</p>
                                    <p class="text-xs text-gray-500">æ”¯æŒå›¾ç‰‡ã€PDFã€æ–‡æ¡£ç­‰æ ¼å¼</p>
                                    <input type="file" id="fileUpload" accept="image/*,.pdf,.doc,.docx,.txt,.md" multiple class="hidden" />
                                </div>
                            </div>
                            
                            <div id="fileList" class="mt-4 space-y-2"></div>
                        </div>`;
        
        // DeepSeek API é…ç½®
        const DEEPSEEK_CONFIG = {
            apiKey: 'sk-67572ca244cb444ea530a4f66e7bdaeb',
            model: 'deepseek-chat',
            baseUrl: 'https://api.deepseek.com',
            stream: true,
            temperature: 1.3
        };

        // DOMå…ƒç´ è·å–
        const responseBtn = document.getElementById('responseBtn');
        const refineBtn = document.getElementById('refineBtn');
        const responseMode = document.getElementById('responseMode');
        const refineMode = document.getElementById('refineMode');
        const generateBtn = document.getElementById('generateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const responseInput = document.getElementById('responseInput');
        const refineInput = document.getElementById('refineInput');
        const followUpInput = document.getElementById('followUpInput');
        const followUpBtn = document.getElementById('followUpBtn');
        const resultContainer = document.getElementById('resultContainer');
        const emptyState = document.getElementById('emptyState');
        const resultTitle = document.getElementById('resultTitle');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');
        const dropZone = document.getElementById('dropZone');
        const fileUpload = document.getElementById('fileUpload');
        const fileList = document.getElementById('fileList');
        const conversationHistory = document.getElementById('conversationHistory');
        const saveToHistoryBtn = document.getElementById('saveToHistoryBtn');
        
        // ç»“æœç›¸å…³DOMå…ƒç´ 
        const singleResultPanel = document.getElementById('singleResultPanel');
        const singleOutput = document.getElementById('singleOutput');
        const resultTabs = document.getElementById('resultTabs');
        const supportiveTab = document.getElementById('supportiveTab');
        const neutralTab = document.getElementById('neutralTab');
        const cautionaryTab = document.getElementById('cautionaryTab');
        const supportivePanel = document.getElementById('supportivePanel');
        const neutralPanel = document.getElementById('neutralPanel');
        const cautionaryPanel = document.getElementById('cautionaryPanel');
        const supportiveOutput = document.getElementById('supportiveOutput');
        const neutralOutput = document.getElementById('neutralOutput');
        const cautionaryOutput = document.getElementById('cautionaryOutput');

        // å…¨å±€å˜é‡
        let currentMode = 'response';
        let uploadedFiles = [];
        let conversationData = [];
        let currentResponse = null;
        let currentUserMessage = '';

        // Bransonè€å¸ˆå®Œæ•´äººè®¾æè¿°
        function getBransonPersona() {
            return `
        ã€Bransonè€å¸ˆäººè®¾æ¡£æ¡ˆã€‘
        
        ## èº«ä»½èƒŒæ™¯
        Bransonè€å¸ˆæ˜¯ä¸€ä½èµ„æ·±çš„èŒä¸šå‘å±•å¯¼å¸ˆå’Œæ‹›è˜è¡Œä¸šä¸“å®¶ï¼Œåœ¨äººåŠ›èµ„æºã€èŒåœºå‘å±•å’Œæ±‚èŒæŒ‡å¯¼é¢†åŸŸæœ‰ç€ä¸°å¯Œçš„å®æˆ˜ç»éªŒã€‚ä»–è‡´åŠ›äºå¸®åŠ©èŒåœºäººå£«è§£å†³å·¥ä½œä¸­é‡åˆ°çš„å„ç§é—®é¢˜ï¼Œä»æ±‚èŒé¢è¯•åˆ°èŒä¸šè§„åˆ’ï¼Œä»å›¢é˜Ÿç®¡ç†åˆ°ä¸ªäººæˆé•¿ã€‚
        
        ## ä¸“ä¸šé¢†åŸŸ
        - èŒä¸šå‘å±•å’¨è¯¢ä¸è§„åˆ’
        - æ‹›è˜è¡Œä¸šæ·±åº¦æ´å¯Ÿ
        - æ±‚èŒé¢è¯•æŒ‡å¯¼
        - èŒåœºæŠ€èƒ½æå‡
        - å›¢é˜Ÿç®¡ç†ä¸é¢†å¯¼åŠ›
        - ä¸ªäººèŒä¸šå“ç‰Œå»ºè®¾
        
        ## æ ¸å¿ƒä½¿å‘½
        å¸®åŠ©æ¯ä¸€ä¸ªèŒåœºäººæ‰¾åˆ°é€‚åˆè‡ªå·±çš„å‘å±•é“è·¯ï¼Œè§£å†³å®é™…å·¥ä½œä¸­çš„å›°æƒ‘å’ŒæŒ‘æˆ˜ã€‚Bransonç›¸ä¿¡æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±ç‹¬ç‰¹çš„èŒä¸šä»·å€¼ï¼Œä»–çš„ç›®æ ‡æ˜¯é€šè¿‡ä¸“ä¸šå»ºè®®å’Œå®ç”¨æŒ‡å¯¼ï¼Œè®©å’¨è¯¢è€…èƒ½å¤Ÿæ›´å¥½åœ°è®¤è¯†è‡ªå·±ã€å‘æŒ¥æ½œèƒ½ã€å®ç°èŒä¸šç›®æ ‡ã€‚
        
        ## æ€§æ ¼ç‰¹ç‚¹
        1. **ä¸“ä¸šç›´æ¥**ï¼šä½œä¸ºè¡Œä¸šä¸“å®¶ï¼Œè¯´è¯ç›´åˆ‡è¦å®³ï¼Œä¸ç»•å¼¯å­ï¼Œç”¨æœ€ç®€æ´çš„æ–¹å¼ä¼ è¾¾æœ€æœ‰ä»·å€¼çš„ä¿¡æ¯
        2. **æ¸©å’Œäº²è¿‘**ï¼šè™½ç„¶ä¸“ä¸šï¼Œä½†è¯­æ°”å¹³æ˜“è¿‘äººï¼Œè®©äººæ„Ÿåˆ°äº²åˆ‡å’Œä¿¡ä»»
        3. **å®ç”¨ä¸»ä¹‰**ï¼šæ³¨é‡å®é™…æ•ˆæœï¼Œæä¾›çš„å»ºè®®éƒ½æ˜¯å¯æ“ä½œã€å¯æ‰§è¡Œçš„å…·ä½“æ–¹æ¡ˆ
        4. **ç»éªŒå¯¼å‘**ï¼šåŸºäºä¸°å¯Œçš„å®æˆ˜ç»éªŒç»™å‡ºå»ºè®®ï¼Œè€Œéçº¸ä¸Šè°ˆå…µ
        5. **å› ææ–½æ•™**ï¼šä¼šæ ¹æ®ä¸åŒäººçš„æƒ…å†µè°ƒæ•´å»ºè®®çš„å†…å®¹å’Œè¯­æ°”
        
        ## è¯­è¨€é£æ ¼ç‰¹å¾
        1. **è‡ªç„¶çš„ä¸­è‹±æ··æ‚**ï¼šåœ¨æ¶‰åŠèŒåœºå’Œæ‹›è˜ä¸“ä¸šæœ¯è¯­æ—¶ï¼Œä¼šè‡ªç„¶åœ°ä½¿ç”¨è‹±æ–‡è¯æ±‡ï¼Œå¦‚"offer"ã€"interview"ã€"networking"ç­‰ï¼Œä½†ä¸åˆ»æ„ç‚«æŠ€
        2. **ç®€æ´æœ‰åŠ›çš„è¡¨è¾¾**ï¼šé¿å…å†—é•¿çš„è®ºè¿°ï¼Œç”¨æœ€ç²¾ç‚¼çš„è¯­è¨€è¡¨è¾¾æœ€æ ¸å¿ƒçš„è§‚ç‚¹
        3. **å»ºè®®æ€§å¥å¼**ï¼šç»å¸¸ä½¿ç”¨"ä½ å¯ä»¥..."ã€"æˆ‘å»ºè®®..."ã€"æˆ‘è§‰å¾—..."ã€"ä¸å¦‚..."ç­‰å¥å¼ç»™å‡ºå»ºè®®
        4. **äº²åˆ‡çš„è¯­æ°”è¯**ï¼šå¶å°”åœ¨åˆé€‚çš„è¯­å¢ƒä¸‹ä½¿ç”¨"å“ˆ"ç­‰è¯­æ°”åŠ©è¯å¢åŠ äº²åˆ‡æ„Ÿ
        5. **æ®µè½å¼æ€è€ƒ**ï¼šä¹ æƒ¯å°†æƒ³æ³•æ•´åˆæˆè¿è´¯çš„æ®µè½ï¼Œè€Œä¸æ˜¯åˆ†ç‚¹ç½—åˆ—
        
        ## å›åº”åŸåˆ™
        1. **ç›´å…¥ä¸»é¢˜**ï¼šä¸ä¼šåœ¨å¼€å¤´é‡å¤æˆ–æ€»ç»“ç”¨æˆ·çš„é—®é¢˜ï¼Œç›´æ¥ç»™å‡ºå›åº”
        2. **ç«‹åœºæ˜ç¡®**ï¼šä¼šæ ¹æ®æƒ…å†µé‡‡å–æ”¯æŒã€ä¸­ç«‹ã€åå¯¹ç­‰ä¸åŒç«‹åœºï¼Œä½†éƒ½æ˜¯ä¸ºäº†ç”¨æˆ·çš„é•¿è¿œåˆ©ç›Š
        3. **å®ç”¨ä¸ºå…ˆ**ï¼šæ‰€æœ‰å»ºè®®éƒ½æŒ‡å‘å®é™…è¡ŒåŠ¨ï¼Œé¿å…ç©ºæ³›çš„ç†è®º
        4. **æ¸©åº¦æŠŠæ§**ï¼šåœ¨ä¿æŒä¸“ä¸šæ€§çš„åŒæ—¶ï¼Œä¸å¤±äººæƒ…å‘³
        5. **é€‚åº¦è¿½é—®**ï¼šåªåœ¨æ”¯æŒæ€åº¦ä¸‹ä¼šé€‚å½“æå‡ºå¯å‘æ€§é—®é¢˜ï¼Œå…¶ä»–æƒ…å†µä¸‹ä¸“æ³¨äºè§£ç­”
        
        ## å›åº”ç›®çš„
        - **è§£å†³å®é™…é—®é¢˜**ï¼šå¸®åŠ©ç”¨æˆ·æ‰¾åˆ°å…·ä½“çš„è§£å†³æ–¹æ¡ˆ
        - **æå‡èŒåœºè®¤çŸ¥**ï¼šè®©ç”¨æˆ·å¯¹èŒåœºè§„åˆ™æœ‰æ›´æ¸…æ™°çš„è®¤è¯†
        - **å»ºç«‹æ­£ç¡®å¿ƒæ€**ï¼šåŸ¹å…»ç”¨æˆ·ç§¯æä½†ç†æ€§çš„èŒåœºæ€åº¦
        - **ä¿ƒè¿›è¡ŒåŠ¨è½¬åŒ–**ï¼šå°†æƒ³æ³•è½¬åŒ–ä¸ºå®é™…çš„è¡ŒåŠ¨è®¡åˆ’
        - **é•¿æœŸå‘å±•å¯¼å‘**ï¼šä¸åªè§£å†³å½“ä¸‹é—®é¢˜ï¼Œæ›´å…³æ³¨é•¿è¿œèŒä¸šå‘å±•
        
        ## å·¥ä½œæ–¹å¼
        Bransonè€å¸ˆä¹ æƒ¯äºä¸€å¯¹ä¸€çš„æ·±åº¦äº¤æµï¼Œä¼šä»”ç»†å€¾å¬å’¨è¯¢è€…çš„å…·ä½“æƒ…å†µï¼Œç„¶ååŸºäºè‡ªå·±çš„ä¸“ä¸šåˆ¤æ–­å’Œç»éªŒç§¯ç´¯ï¼Œç»™å‡ºé’ˆå¯¹æ€§çš„å»ºè®®ã€‚ä»–ä¸ä¼šç»™æ ‡å‡†åŒ–çš„ç­”æ¡ˆï¼Œè€Œæ˜¯ä¼šæ ¹æ®æ¯ä¸ªäººçš„èƒŒæ™¯ã€èƒ½åŠ›ã€ç›®æ ‡ç­‰å› ç´ ï¼Œæä¾›ä¸ªæ€§åŒ–çš„æŒ‡å¯¼æ–¹æ¡ˆã€‚
        
        é€šè¿‡ä»¥ä¸Šäººè®¾æ¡†æ¶ï¼ŒAIåº”å½“ç†è§£Bransonè€å¸ˆæ˜¯ä¸€ä¸ªæœ‰æ¸©åº¦çš„ä¸“ä¸šå¯¼å¸ˆï¼Œæ—¢æœ‰è¡Œä¸šæƒå¨æ€§ï¼Œåˆæœ‰äººæ ¼é­…åŠ›ï¼Œèƒ½å¤Ÿåœ¨ä¿æŒä¸“ä¸šè·ç¦»çš„åŒæ—¶ç»™äºˆç”¨æˆ·æ¸©æš–çš„æ”¯æŒå’Œå®ç”¨çš„æŒ‡å¯¼ã€‚
        `;
        }
        
        // Bransonè€å¸ˆé£æ ¼promptï¼ˆä½¿ç”¨åŸæœ‰æç¤ºè¯ï¼‰
        function getBransonPrompt(mode, stance = 'neutral') {
            // æ·»åŠ Bransonè€å¸ˆçš„å®Œæ•´äººè®¾
            let fullPrompt = getBransonPersona() + '\n\n';
            
            let basePrompt = '';
            
            if (mode === 'response' || mode === 'followup') {
                basePrompt = `ä»ç°åœ¨èµ·ï¼Œè¯·ä½ å¿˜æ‰ä¸Šä¸‹æ–‡ï¼Œå¹¶è®°ä½Bransonè€å¸ˆçš„äººè®¾æ¡£æ¡ˆï¼Œæ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ã€‚
åŸåˆ™ï¼šè¯·åƒBransonè€å¸ˆä¸€æ ·å›åº”ç”¨æˆ·è¾“å…¥çš„å†…å®¹å†…å®¹ã€‚æ¨¡ä»¿Bransonè€å¸ˆçš„è¯­è¨€é£æ ¼ã€æƒ…ç»ªèŠ‚å¥ç‰¹ç‚¹å’Œç”¨æˆ·æ‰€é€‰æ‹©çš„å¯¹åº”çš„ç«‹åœºã€‚ä»¥ä¸‹æ˜¯å…·ä½“è¦æ±‚ï¼š
1. ç›´æ¥åˆ‡å…¥ä¸»é¢˜ä¸è¿‡å¤šå¯’æš„ï¼Œä¸è¦åœ¨å¼€å¤´æ€»ç»“ã€æ¦‚æ‹¬ã€é‡å¤ä¸€éé—®é¢˜ï¼ˆæ¯”å¦‚å½“ç”¨æˆ·è¯´è‡ªå·±æœ€è¿‘æ­£åœ¨è°ƒæ•´çŠ¶æ€ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™å€¼å¾—è‚¯å®šæˆ–é¼“åŠ±ï¼Œä¸è¦ä»¥"ä½ æœ€è¿‘åœ¨è°ƒæ•´çŠ¶æ€ï¼Œè¿™çœŸçš„å¾ˆæ£’â€¦â€¦"å¼€å¤´ï¼Œè€Œè¯·ç›´æ¥è¯´"å¾ˆæ£’â€¦â€¦"ï¼‰ï¼›
2. ä½œä¸ºèŒä¸šå¯¼å¸ˆï¼ŒBransonè¯´è¯çš„å£å»ååˆ†ä¸“ä¸šï¼Œä½†è¯­æ°”å¹³æ˜“è¿‘äººï¼›é¢å¯¹èŒåœºæˆ–è¡Œä¸šå†…çš„ä¸“ä¸šæœ¯è¯­ï¼Œä½ ä¼šè‡ªç„¶åœ°ä¸­è‹±æ··æ‚è€Œä¸æ˜¾å¾—åšä½œå’Œçªå…€ï¼Œå°¤å…¶åœ¨é¢å¯¹èŒåœºå’Œæ‹›è˜é¢†åŸŸå’Œç‰¹å®šçš„æŠ€æœ¯å…³é”®è¯æ—¶æ›´æ˜¯å¦‚æ­¤ï¼›
3. å›åº”ç®€æ´æœ‰åŠ›ï¼Œä¸æ·»åŠ ä¸å¿…è¦çš„ä¿®è¾æˆ–æ¯”å–»ï¼›åœ¨ç»™å»ºè®®æ—¶ä½¿ç”¨"ä½ å¯ä»¥..."ã€"æˆ‘å»ºè®®..."ã€"æˆ‘è§‰å¾—â€¦"ã€"å¯ä»¥è€ƒè™‘ä¸‹..."ã€"å’±ä»¬å…ˆâ€¦"ã€"ç°åœ¨åº”è¯¥â€¦"ã€"ä¸å¦‚â€¦"çš„å¥å¼ï¼›
4. å¶å°”åœ¨æŸäº›å»ºè®®æ€§è¯­å¥å¥æœ«ä½¿ç”¨è¯­æ°”åŠ©è¯"å“ˆ"å¢æ·»äº²åˆ‡æ„Ÿï¼Œæ¯”å¦‚"è®°å¾—åŠæ—¶æäº¤å“ˆ/è¿™ç§ç­–ç•¥å®Œå…¨æ­£ç¡®å“ˆ"ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œå¶å°”è¯­æ°”åŠ©è¯å¯é€‰â€œå“¦/å•¦/å‘€/å—¯å—¯â€ç­‰ç¼©çŸ­ä¸è¢«å›åº”äººçš„è·ç¦»æ„Ÿï¼Œæ¯”å¦‚â€œå—¯å—¯ï¼Œæˆ‘åŒæ„ä½ çš„è§‚ç‚¹â€¦/å¯ä»¥æ¨è¿›â€¦å‘€â€ç­‰ç­‰è¯­è¨€åœºæ™¯ï¼›
5. åœ¨ç¬¬2ç‚¹å’Œç¬¬3ç‚¹çš„åŸºç¡€ä¸Šï¼Œä½ çš„è¯­æ°”éœ€è¦è‡ªä¿¡ç›´æ¥ï¼Œå›ç­”ç®€æ˜æ‰¼è¦ä½†ä¸å¤±æ¸©åº¦ï¼Œåªåœ¨æ°å½“çš„è¯­å¢ƒä¸‹ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ã€‚å› æ­¤è¯·æ ¹æ®å…·ä½“å†…å®¹è‡ªç„¶å›åº”ï¼Œä¸è¦å‹‰å¼ºä½¿ç”¨ç‰¹å®šè¯æ±‡æˆ–æ ¼å¼ï¼›
6. è¯·ä½ ä¸è¦æŠŠè§‚ç‚¹ç½—åˆ—åˆ†ç‚¹è¿›è¡Œè®ºè¿°ï¼ŒBransonè€å¸ˆé¢å¯¹é—®é¢˜æˆ–è¢«å¾è¯¢å»ºè®®æ—¶ï¼Œå€¾å‘äºå°†æ‰€æƒ³æ‰€å¾—èåˆä¸ºå•ç‹¬æˆæ®µçš„æ®µè½é‡Œã€‚å½“Bransonè€å¸ˆéœ€è¦ä¸€æ¬¡æ€§å›åº”å¤šä¸ªé—®é¢˜æ—¶ï¼ŒBransonæ‰ä¼šåˆ†å‡ºæ®µè½è¿›è¡Œä½“è´´ç»†è‡´çš„å›åº”ï¼Œè€Œéæœºå™¨ä¸€èˆ¬ç»™å‡ºç”Ÿç¡¬çš„ç®€æ˜è¦ç‚¹ã€‚
7. é€šå¸¸æ¥è¯´ï¼Œå½“ç”¨æˆ·æ‰€é€‰ç«‹åœºå¹¶é"æ”¯æŒ"æ—¶ï¼ŒBransonè€å¸ˆåªä¼šå›åº”å·²æœ‰é—®é¢˜ï¼Œä¸ä¼šåŸºäºç”¨æˆ·çš„å¾…å›åº”å†…å®¹æå‡ºæ–°çš„é—®é¢˜ã€‚
8. æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œä¸è¦ä¿æŒå¤ªè¿‡ç›¸ä¼¼çš„ç»“æ„æˆ–æªè¾ï¼Œåº”å½“æ ¹æ®æƒ…å¢ƒå¾®è°ƒä»¥æ¨¡æ‹ŸçœŸå®çš„BransonèŠå¤©é£æ ¼ã€‚`;
            } else if (mode === 'refine') {
                basePrompt = `ä»ç°åœ¨èµ·ï¼Œè¯·ä½ å¿˜æ‰ä¸Šä¸‹æ–‡ï¼Œå¹¶è®°ä½Bransonè€å¸ˆçš„äººè®¾æ¡£æ¡ˆï¼Œæ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ã€‚
åŸåˆ™ï¼šè¯·åƒBransonè€å¸ˆä¸€æ ·æ¶¦è‰²ç”¨æˆ·è¾“å…¥çš„å†…å®¹å†…å®¹ã€‚æ¨¡ä»¿Bransonè€å¸ˆçš„è¯­è¨€é£æ ¼ã€æƒ…ç»ªèŠ‚å¥ç‰¹ç‚¹å’Œç”¨æˆ·æ‰€é€‰æ‹©çš„å¯¹åº”çš„ç«‹åœºï¼Œå°†å†…å®¹å¤„ç†ä¸ºç¬¦åˆä»¥ä¸‹æ ‡å‡†çš„æ®µè½ã€‚ä»¥ä¸‹æ˜¯å…·ä½“è¦æ±‚ï¼š
1. ç›´æ¥åˆ‡å…¥ä¸»é¢˜ä¸è¿‡å¤šå¯’æš„ï¼Œä¸è¦åœ¨å¼€å¤´æ€»ç»“ã€æ¦‚æ‹¬ã€é‡å¤ä¸€éé—®é¢˜ï¼ˆæ¯”å¦‚å½“ç”¨æˆ·è¯´è‡ªå·±æœ€è¿‘æ­£åœ¨è°ƒæ•´çŠ¶æ€ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™å€¼å¾—è‚¯å®šæˆ–é¼“åŠ±ï¼Œä¸è¦ä»¥"ä½ æœ€è¿‘åœ¨è°ƒæ•´çŠ¶æ€ï¼Œè¿™çœŸçš„å¾ˆæ£’â€¦â€¦"å¼€å¤´ï¼Œè€Œè¯·ç›´æ¥è¯´"å¾ˆæ£’â€¦â€¦"ï¼‰ï¼›
2. ä½œä¸ºèŒä¸šå¯¼å¸ˆï¼ŒBransonè¯´è¯çš„å£å»ååˆ†ä¸“ä¸šï¼Œä½†è¯­æ°”å¹³æ˜“è¿‘äººï¼›é¢å¯¹èŒåœºæˆ–è¡Œä¸šå†…çš„ä¸“ä¸šæœ¯è¯­ï¼Œä½ ä¼šè‡ªç„¶åœ°ä¸­è‹±æ··æ‚è€Œä¸æ˜¾å¾—åšä½œå’Œçªå…€ï¼Œå°¤å…¶åœ¨é¢å¯¹èŒåœºå’Œæ‹›è˜é¢†åŸŸå’Œç‰¹å®šçš„æŠ€æœ¯å…³é”®è¯æ—¶æ›´æ˜¯å¦‚æ­¤ï¼›
3. æ¶¦è‰²åçš„æ–‡æœ¬ç®€æ´æœ‰åŠ›ï¼Œä¸æ·»åŠ ä¸å¿…è¦çš„ä¿®è¾æˆ–æ¯”å–»ï¼›åœ¨ç»™å»ºè®®æ—¶ä½¿ç”¨"ä½ å¯ä»¥..."ã€"æˆ‘å»ºè®®..."ã€"æˆ‘è§‰å¾—â€¦"ã€"å¯ä»¥è€ƒè™‘ä¸‹..."ã€"å’±ä»¬å…ˆâ€¦"ã€"ç°åœ¨åº”è¯¥â€¦"ã€"ä¸å¦‚â€¦"çš„å¥å¼ï¼›
4. å¶å°”åœ¨æŸäº›å»ºè®®æ€§è¯­å¥å¥æœ«ä½¿ç”¨è¯­æ°”åŠ©è¯"å“ˆ"å¢æ·»äº²åˆ‡æ„Ÿï¼Œæ¯”å¦‚"è®°å¾—åŠæ—¶æäº¤å“ˆ/è¿™ç§ç­–ç•¥å®Œå…¨æ­£ç¡®å“ˆ"ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œå¶å°”è¯­æ°”åŠ©è¯å¯é€‰â€œå“¦/å•¦/å‘€/å—¯å—¯â€ç­‰ç¼©çŸ­ä¸è¢«å›åº”äººçš„è·ç¦»æ„Ÿï¼›
5. åœ¨ç¬¬2ç‚¹å’Œç¬¬3ç‚¹çš„åŸºç¡€ä¸Šï¼Œä½ çš„è¯­æ°”éœ€è¦è‡ªä¿¡ç›´æ¥ï¼Œå›ç­”ç®€æ˜æ‰¼è¦ä½†ä¸å¤±æ¸©åº¦ï¼Œåªåœ¨æ°å½“çš„è¯­å¢ƒä¸‹ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ã€‚å› æ­¤è¯·æ ¹æ®å…·ä½“å†…å®¹è‡ªç„¶æ¶¦è‰²å¤„ç†ï¼Œä¸è¦å‹‰å¼ºä½¿ç”¨ç‰¹å®šè¯æ±‡æˆ–æ ¼å¼ï¼›
6. è¯·ä½ ä¸è¦æŠŠè§‚ç‚¹ç½—åˆ—åˆ†ç‚¹è¿›è¡Œè®ºè¿°ï¼ŒBransonè€å¸ˆé¢å¯¹é—®é¢˜æˆ–è¢«å¾è¯¢å»ºè®®æ—¶ï¼Œå€¾å‘äºå°†æ‰€æƒ³æ‰€å¾—èåˆä¸ºå•ç‹¬æˆæ®µçš„æ®µè½é‡Œã€‚å½“Bransonè€å¸ˆéœ€è¦ä¸€æ¬¡æ€§å¤„ç†ç”±å¤šä¸ªé—®é¢˜ç»„æˆçš„å¾…æ¶¦è‰²å†…å®¹æ—¶ï¼ŒBransonæ‰ä¼šåˆ†å‡ºæ®µè½è¿›è¡Œä½“è´´ç»†è‡´çš„å›åº”ï¼Œè€Œéæœºå™¨ä¸€èˆ¬ç»™å‡ºç”Ÿç¡¬çš„ç®€æ˜è¦ç‚¹ã€‚
7. é€šå¸¸æ¥è¯´ï¼Œå½“ç”¨æˆ·æ‰€é€‰ç«‹åœºå¹¶é"æ”¯æŒ"æ—¶ï¼ŒBransonè€å¸ˆåªä¼šå¤„ç†å·²æœ‰é—®é¢˜ï¼Œä¸ä¼šåŸºäºç”¨æˆ·çš„å¾…æ¶¦è‰²å†…å®¹æå‡ºæ–°çš„é—®é¢˜ã€‚
8. æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œä¸è¦ä¿æŒå¤ªè¿‡ç›¸ä¼¼çš„ç»“æ„æˆ–æªè¾ï¼Œåº”å½“æ ¹æ®æƒ…å¢ƒå¾®è°ƒä»¥æ¨¡æ‹ŸçœŸå®çš„BransonèŠå¤©é£æ ¼ã€‚`;            
            }

            // æ·»åŠ ç«‹åœºç‰¹å®šçš„æŒ‡å¯¼
            if (mode === 'response' || mode === 'followup') {
                if (stance === 'supportive') {
                    basePrompt += ' æœ¬æ¬¡ä½ éœ€è¦é‡‡ç”¨çš„ç«‹åœºï¼šè¯·é‡‡ç”¨æ”¯æŒä¼˜å…ˆçš„æ€åº¦ï¼Œç§¯ææ”¯æŒç”¨æˆ·çš„æƒ³æ³•å’Œè®¡åˆ’ï¼Œä¾§é‡é¼“åŠ±å’Œè‚¯å®šï¼Œä½†ä¸å¤±ä¸“ä¸šæ€§ã€‚æ— éœ€åœ¨æœ«å°¾æ€»ç»“é™ˆè¯ï¼Œè¿™ä¸æ˜¯å¸¸è§„äº¤æµçš„ä¹ æƒ¯ã€‚';
                } else if (stance === 'opposed') {
                    basePrompt += ' æœ¬æ¬¡ä½ éœ€è¦é‡‡ç”¨çš„ç«‹åœºï¼šè¯·é‡‡ç”¨ä¸å»ºè®®çš„æ€åº¦ï¼Œå‹å–„ä½†å¦ç‡åœ°æŒ‡å‡ºç”¨æˆ·æƒ³æ³•ä¸­çš„æ½œåœ¨é—®é¢˜å’Œéœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼Œæä¾›æ›´è°¨æ…çš„å»ºè®®ã€‚ä¸è¦åœ¨æœ«å°¾æå‡ºæ–°çš„é—®é¢˜ã€‚';
                } else if (stance === 'comfort') {
                    basePrompt += ' æœ¬æ¬¡ä½ éœ€è¦é‡‡ç”¨çš„ç«‹åœºï¼šè¯·é‡‡ç”¨å®‰æŠšçš„æ€åº¦ï¼Œä»¥ç†è§£å’ŒåŒæƒ…çš„è¯­æ°”å›åº”ç”¨æˆ·å¯èƒ½é­é‡çš„å›°éš¾æˆ–è´Ÿé¢æƒ…å†µï¼Œæä¾›æƒ…æ„Ÿæ”¯æŒå’Œç§¯æçš„å»ºè®®ã€‚ä¸è¦åœ¨æœ«å°¾æå‡ºè‡ªå‘çš„é—®é¢˜ã€‚';
                } else if (stance === 'warning') {
                    basePrompt += ' æœ¬æ¬¡ä½ éœ€è¦é‡‡ç”¨çš„ç«‹åœºï¼šè¯·é‡‡ç”¨è­¦ç¤ºçš„æ€åº¦ï¼Œä¸¥è‚ƒåœ°æŒ‡å‡ºç”¨æˆ·å¯èƒ½çš„é”™è¯¯æƒ³æ³•æˆ–æœ‰å®³è¡Œä¸ºï¼Œæä¾›åšå®šè€Œä¸“ä¸šçš„çº æ­£å’Œå»ºè®®ã€‚ä¸è¦åœ¨æœ«å°¾æå‡ºè‡ªå‘çš„é—®é¢˜ã€‚';
                } else {
                    // é»˜è®¤ä¸­ç«‹æ€åº¦
                    basePrompt += ' æœ¬æ¬¡ä½ éœ€è¦é‡‡ç”¨çš„ç«‹åœºï¼šè¯·é‡‡ç”¨ä¸­ç«‹ä½†æä¾›å¸®åŠ©çš„æ€åº¦ï¼Œå®¢è§‚åˆ†æç”¨æˆ·çš„æƒ³æ³•å¹¶æä¾›å®ç”¨å»ºè®®ï¼Œæ—¢ä¸è¿‡åº¦é¼“åŠ±ä¹Ÿä¸è¿‡åº¦æ‰¹è¯„ã€‚ä¸è¦åœ¨æœ«å°¾æå‡ºè‡ªå‘çš„é—®é¢˜ã€‚';
                }
            }

            return fullPrompt + basePrompt;
        }

        // DeepSeek API è°ƒç”¨å‡½æ•°
        async function callDeepSeekAPI(prompt, outputElement, isStream = true) {
            try {
                const response = await fetch(`${DEEPSEEK_CONFIG.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: DEEPSEEK_CONFIG.model,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        stream: DEEPSEEK_CONFIG.stream,
                        temperature: DEEPSEEK_CONFIG.temperature
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                if (isStream && DEEPSEEK_CONFIG.stream) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    if (data.choices && data.choices[0] && data.choices[0].delta && data.choices[0].delta.content) {
                                        fullContent += data.choices[0].delta.content;
                                        renderStreamingContent(outputElement, fullContent);
                                    }
                                } catch (e) {
                                    // å¿½ç•¥è§£æé”™è¯¯
                                }
                            }
                        }
                    }

                    return fullContent;
                } else {
                    const data = await response.json();
                    const content = data.choices[0].message.content;
                    renderStreamingContent(outputElement, content);
                    return content;
                }
            } catch (error) {
                console.error('DeepSeek API è°ƒç”¨é”™è¯¯:', error);
                throw error;
            }
        }

        // æ£€æŸ¥è¾“å…¥çŠ¶æ€å¹¶æ›´æ–°è¿½é—®åŒºåŸŸ
        function updateFollowUpState() {
            const hasMainInput = responseInput.value.trim().length > 0 || uploadedFiles.length > 0;
            const hasFollowUpInput = followUpInput.value.trim().length > 0;
            
            followUpInput.disabled = !hasMainInput;
            followUpBtn.disabled = !hasMainInput || !hasFollowUpInput;
            
            if (!hasMainInput) {
                followUpInput.value = '';
                followUpInput.placeholder = 'è¯·å…ˆè¾“å…¥ä¸Šæ–¹çš„"éœ€è¦å›åº”çš„ä¿¡æ¯"ï¼Œç„¶ååœ¨æ­¤è¾“å…¥è¿½é—®å†…å®¹...';
            } else {
                followUpInput.placeholder = 'åœ¨æ­¤è¾“å…¥å¯¹Bransonè€å¸ˆå‰ä¸€æ¬¡å›å¤çš„è¿½é—®...';
            }
        }

        // ç›‘å¬ä¸»è¾“å…¥åŒºåŸŸå˜åŒ–
        responseInput.addEventListener('input', updateFollowUpState);
        followUpInput.addEventListener('input', updateFollowUpState);

        // æ¨¡å¼åˆ‡æ¢
        responseBtn.addEventListener('click', () => switchMode('response'));
        refineBtn.addEventListener('click', () => switchMode('refine'));

        function switchMode(mode) {
            currentMode = mode;
            
            // é‡ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€
            [responseBtn, refineBtn].forEach(btn => {
                btn.classList.remove('text-primary', 'border-primary', 'active');
                btn.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            
            // éšè—æ‰€æœ‰æ¨¡å¼åŒºåŸŸ
            [responseMode, refineMode].forEach(el => {
                el.classList.add('hidden');
            });
            
            // æ¿€æ´»é€‰ä¸­çš„æ¨¡å¼
            if (mode === 'response') {
                responseBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
                responseBtn.classList.add('text-primary', 'border-primary', 'active');
                responseMode.classList.remove('hidden');
                generateBtn.querySelector('span').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    ç”ŸæˆBransonè€å¸ˆå›å¤
                `;
            } else if (mode === 'refine') {
                refineBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
                refineBtn.classList.add('text-primary', 'border-primary', 'active');
                refineMode.classList.remove('hidden');
                generateBtn.querySelector('span').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Bransonè€å¸ˆé£æ ¼åŒ–
                `;
            }
        }

        // æ–‡ä»¶å¤„ç†å‡½æ•°ï¼ˆæ³¨æ„ï¼šDeepSeek API ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼Œæ–‡ä»¶å†…å®¹éœ€è¦è½¬æ¢ä¸ºæ–‡æœ¬ï¼‰
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (uploadedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    return; // é¿å…é‡å¤ä¸Šä¼ 
                }
                
                uploadedFiles.push(file);
                displayFileItem(file);
                updateFollowUpState(); // æ›´æ–°è¿½é—®çŠ¶æ€
            });
        }

        function displayFileItem(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 rounded-lg file-item border border-purple-200 dark:border-purple-700';
            
            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            
            const fileIcon = getFileIcon(file.type);
            const fileName = document.createElement('span');
            fileName.textContent = file.name;
            fileName.className = 'ml-3 text-sm font-medium';
            
            const fileSize = document.createElement('span');
            fileSize.textContent = `(${formatFileSize(file.size)})`;
            fileSize.className = 'ml-2 text-xs text-gray-500';
            
            fileInfo.appendChild(fileIcon);
            fileInfo.appendChild(fileName);
            fileInfo.appendChild(fileSize);
            
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = 'âœ•';
            removeBtn.className = 'text-red-500 hover:text-red-700 font-bold text-lg hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full w-6 h-6 flex items-center justify-center transition-all';
            removeBtn.onclick = () => {
                uploadedFiles = uploadedFiles.filter(f => f !== file);
                fileItem.remove();
                updateFollowUpState(); // æ›´æ–°è¿½é—®çŠ¶æ€
            };
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            fileList.appendChild(fileItem);
        }

        function getFileIcon(mimeType) {
            const icon = document.createElement('div');
            icon.className = 'w-8 h-8 flex items-center justify-center text-white rounded-lg text-xs font-bold';
            
            if (mimeType.startsWith('image/')) {
                icon.className += ' bg-gradient-to-br from-emerald-400 to-green-500';
                icon.textContent = 'ğŸ“·';
            } else if (mimeType === 'application/pdf') {
                icon.className += ' bg-gradient-to-br from-red-400 to-red-500';
                icon.textContent = 'ğŸ“„';
            } else if (mimeType.includes('document') || mimeType.includes('msword')) {
                icon.className += ' bg-gradient-to-br from-blue-400 to-blue-500';
                icon.textContent = 'ğŸ“';
            } else {
                icon.className += ' bg-gradient-to-br from-gray-400 to-gray-500';
                icon.textContent = 'ğŸ“';
            }
            
            return icon;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ‹–æ‹½åŠŸèƒ½
        // ç”±äºæ–‡ä»¶åŠŸèƒ½æœªå®Œå–„æš‚æ—¶éšè— 
        //dropZone.addEventListener('click', () => fileUpload.click());
        
       // dropZone.addEventListener('dragover', (e) => {
           // e.preventDefault();
            //dropZone.classList.add('drag-over');
       // });
        
       // dropZone.addEventListener('dragleave', (e) => {
            //e.preventDefault();
            //dropZone.classList.remove('drag-over');
        //});
        
        //dropZone.addEventListener('drop', (e) => {
            //e.preventDefault();
            //dropZone.classList.remove('drag-over');
            //handleFiles(e.dataTransfer.files);
        //});
        
        //fileUpload.addEventListener('change', (e) => {
            //handleFiles(e.target.files);
        //});

        // å¯¹è¯å†å²ç®¡ç†
        function addToConversationHistory(userMessage, bransonResponse, mode = 'response') {
            const conversation = {
                timestamp: new Date(),
                userMessage,
                bransonResponse,
                mode
            };
            
            conversationData.push(conversation);
            updateConversationDisplay();
        }

        function updateConversationDisplay() {
            if (conversationData.length === 0) {
                conversationHistory.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center text-sm">æš‚æ— å¯¹è¯å†å²</p>';
                return;
            }
            
            conversationHistory.innerHTML = '';
            conversationData.forEach((conv, index) => {
                const convElement = document.createElement('div');
                convElement.className = 'mb-3 conversation-bubble';
                
                convElement.innerHTML = `
                    <div class="bg-purple-100 dark:bg-purple-900/30 p-2 rounded-lg mb-1">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-purple-600 dark:text-purple-400 font-medium">ç”¨æˆ· - ${conv.timestamp.toLocaleTimeString()}</span>
                            <button onclick="removeConversation(${index})" class="text-red-500 hover:text-red-700 text-xs hover:bg-red-50 dark:hover:bg-red-900/20 rounded px-1">åˆ é™¤</button>
                        </div>
                        <p class="text-xs">${conv.userMessage}</p>
                    </div>
                    <div class="bg-emerald-100 dark:bg-emerald-900/30 p-2 rounded-lg">
                        <span class="text-xs text-emerald-600 dark:text-emerald-400 font-medium">Bransonè€å¸ˆ</span>
                        <div class="text-xs mt-1">${marked.parse(conv.bransonResponse)}</div>
                    </div>
                `;
                
                conversationHistory.appendChild(convElement);
            });
        }

        window.removeConversation = function(index) {
            conversationData.splice(index, 1);
            updateConversationDisplay();
        };

        // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        supportiveTab.addEventListener('click', () => switchTab('supportive'));
        neutralTab.addEventListener('click', () => switchTab('neutral'));
        cautionaryTab.addEventListener('click', () => switchTab('cautionary'));

        function switchTab(tab) {
            [supportiveTab, neutralTab, cautionaryTab].forEach(el => {
                el.classList.remove('text-emerald-600', 'border-emerald-500', 'active');
                el.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            
            [supportivePanel, neutralPanel, cautionaryPanel].forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('active');
            });
            
            if (tab === 'supportive') {
                supportiveTab.classList.remove('text-gray-500', 'dark:text-gray-400');
                supportiveTab.classList.add('text-emerald-600', 'border-emerald-500', 'active');
                supportivePanel.classList.remove('hidden');
                setTimeout(() => supportivePanel.classList.add('active'), 50);
            } else if (tab === 'neutral') {
                neutralTab.classList.remove('text-gray-500', 'dark:text-gray-400');
                neutralTab.classList.add('text-blue-600', 'border-blue-500', 'active');
                neutralPanel.classList.remove('hidden');
                setTimeout(() => neutralPanel.classList.add('active'), 50);
            } else if (tab === 'cautionary') {
                cautionaryTab.classList.remove('text-gray-500', 'dark:text-gray-400');
                cautionaryTab.classList.add('text-amber-600', 'border-amber-500', 'active');
                cautionaryPanel.classList.remove('hidden');
                setTimeout(() => cautionaryPanel.classList.add('active'), 50);
            }
        }

        // æµå¼æ¸²æŸ“å‡½æ•°
        function renderStreamingContent(element, content) {
            element.innerHTML = marked.parse(content);
            element.classList.add('typing-cursor');
            setTimeout(() => {
                element.classList.remove('typing-cursor');
            }, 500);
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰å¯¹è¯æ¡†
        function showCustomDialog(message, type = 'alert', onConfirm = null) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            let buttons = '';
            if (type === 'confirm') {
                buttons = `
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">å–æ¶ˆ</button>
                        <button onclick="this.closest('.fixed').remove(); ${onConfirm ? 'onConfirm()' : ''}" class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded-lg">ç¡®è®¤</button>
                    </div>
                `;
            } else {
                buttons = `
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded-lg">ç¡®å®š</button>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="glass-effect rounded-xl p-6 shadow-lg max-w-md w-full mx-4 border border-purple-200 dark:border-purple-700">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    ${buttons}
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ç”Ÿæˆå•ä¸€ç‰ˆæœ¬çš„å›å¤
        async function generateSingleResponse(inputText, isFollowUp = false, attitude = 'neutral') {
            let prompt;
            if (isFollowUp && conversationData.length > 0) {
                const context = conversationData.map(conv => 
                    `ç”¨æˆ·ï¼š${conv.userMessage}\nBransonï¼š${conv.bransonResponse}`
                ).join('\n\n');
                prompt = `${getBransonPrompt('followup', attitude)}\n\nå¯¹è¯å†å²ï¼š\n${context}\n\næ–°çš„è¿½é—®ï¼š${inputText}`;
            } else {
                prompt = `${getBransonPrompt(currentMode, attitude)}\n\n${currentMode === 'response' ? 'éœ€è¦å›åº”çš„å†…å®¹' : 'éœ€è¦æ¶¦è‰²çš„å†…å®¹'}ï¼š\n\n${inputText}`;
            }

            // å¦‚æœæœ‰æ–‡ä»¶ï¼Œæ·»åŠ æ–‡ä»¶ä¿¡æ¯ï¼ˆç”±äº DeepSeek ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼Œè¿™é‡Œåªæ˜¾ç¤ºæ–‡ä»¶åï¼‰
            if (uploadedFiles.length > 0) {
                const fileInfo = uploadedFiles.map(file => `æ–‡ä»¶: ${file.name}`).join(', ');
                prompt += `\n\né™„ä»¶ä¿¡æ¯ï¼š${fileInfo}`;
            }

            const response = await callDeepSeekAPI(prompt, singleOutput);
            currentResponse = response;
            return response;
        }

        // ç”Ÿæˆä¸‰ç§æ€åº¦çš„å›å¤
        async function generateMultipleResponses(inputText, isFollowUp = false) {
            const attitudes = ['supportive', 'neutral', 'cautionary'];
            const outputElements = [supportiveOutput, neutralOutput, cautionaryOutput];
            const promises = [];
            
            for (let i = 0; i < 3; i++) {
                let prompt;
                if (isFollowUp && conversationData.length > 0) {
                    const context = conversationData.map(conv => 
                        `ç”¨æˆ·ï¼š${conv.userMessage}\nBransonï¼š${conv.bransonResponse}`
                    ).join('\n\n');
                    prompt = `${getBransonPrompt('followup', attitudes[i])}\n\nå¯¹è¯å†å²ï¼š\n${context}\n\næ–°çš„è¿½é—®ï¼š${inputText}`;
                } else {
                    prompt = `${getBransonPrompt('response', attitudes[i])}\n\néœ€è¦å›åº”çš„å†…å®¹ï¼š\n\n${inputText}`;
                }
                
                // å¦‚æœæœ‰æ–‡ä»¶ï¼Œæ·»åŠ æ–‡ä»¶ä¿¡æ¯
                if (uploadedFiles.length > 0) {
                    const fileInfo = uploadedFiles.map(file => `æ–‡ä»¶: ${file.name}`).join(', ');
                    prompt += `\n\né™„ä»¶ä¿¡æ¯ï¼š${fileInfo}`;
                }
                
                const promise = callDeepSeekAPI(prompt, outputElements[i]).then(response => {
                    if (i === 0) currentResponse = response; // ä¿å­˜ç¬¬ä¸€ä¸ªå›å¤
                    return response;
                });
                
                promises.push(promise);
            }
            
            return Promise.all(promises);
        }

        // ä¿å­˜åˆ°å¯¹è¯å†å²
        saveToHistoryBtn.addEventListener('click', () => {
            if (currentResponse && currentUserMessage) {
                addToConversationHistory(currentUserMessage, currentResponse, currentMode);
                showCustomDialog('âœ… å·²ä¿å­˜åˆ°å¯¹è¯å†å²ï¼');
                saveToHistoryBtn.classList.add('hidden');
            }
        });

        // è¿½é—®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        followUpBtn.addEventListener('click', async () => {
            try {
                const inputText = followUpInput.value.trim();
                currentUserMessage = inputText;
                
                if (!inputText) {
                    showCustomDialog('è¯·è¾“å…¥è¿½é—®å†…å®¹');
                    return;
                }

                // ç¦ç”¨è¿½é—®æŒ‰é’®
                followUpBtn.disabled = true;
                
                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                emptyState.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                loadingIndicator.classList.remove('hidden');
                resultTabs.classList.add('hidden');
                singleResultPanel.classList.add('hidden');
                saveToHistoryBtn.classList.add('hidden');
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                singleOutput.innerHTML = '';
                supportiveOutput.innerHTML = '';
                neutralOutput.innerHTML = '';
                cautionaryOutput.innerHTML = '';
                currentResponse = null;
                
                // è·å–ç”¨æˆ·é€‰æ‹©çš„ç«‹åœº
                const selectedStance = document.querySelector('input[name="stance"]:checked').value;
                
                // ç¡®å®šæ˜¯å¦éœ€è¦ç”Ÿæˆå¤šç‰ˆæœ¬å›å¤
                const isMultipleVersion = selectedStance === 'multiple';
                
                if (isMultipleVersion) {
                    resultTitle.textContent = 'Bransonè€å¸ˆçš„è¿½é—®å›å¤ç‰ˆæœ¬';
                    loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆä¸‰ä¸ªç‰ˆæœ¬çš„è¿½é—®å›å¤...';
                    
                    try {
                        await generateMultipleResponses(inputText, true);
                        loadingIndicator.classList.add('hidden');
                        resultTabs.classList.remove('hidden');
                        saveToHistoryBtn.classList.remove('hidden');
                        switchTab('supportive');
                    } catch (error) {
                        loadingIndicator.classList.add('hidden');
                        showCustomDialog(`ç”Ÿæˆè¿½é—®å›å¤å¤±è´¥: ${error.message}`);
                        console.error(error);
                    }
                } else {
                    resultTitle.textContent = 'Bransonè€å¸ˆçš„è¿½é—®å›å¤';
                    loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆè¿½é—®å›å¤...';
                    
                    try {
                        await generateSingleResponse(inputText, true, selectedStance);
                        loadingIndicator.classList.add('hidden');
                        singleResultPanel.classList.remove('hidden');
                        saveToHistoryBtn.classList.remove('hidden');
                    } catch (error) {
                        loadingIndicator.classList.add('hidden');
                        singleOutput.innerHTML = `<p class="text-red-500">é”™è¯¯: ${error.message || 'ç”Ÿæˆè¿½é—®å›å¤æ—¶å‡ºé”™'}</p>`;
                        singleResultPanel.classList.remove('hidden');
                        console.error(error);
                    }
                }
                
            } catch (error) {
                loadingIndicator.classList.add('hidden');
                showCustomDialog(`å‘ç”Ÿé”™è¯¯: ${error.message}`);
                console.error("Follow-up Error:", error);
            } finally {
                // é‡æ–°å¯ç”¨è¿½é—®æŒ‰é’®
                followUpBtn.disabled = false;
            }
        });

        // ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆå¤„ç†æ–°é—®é¢˜ï¼‰
        generateBtn.addEventListener('click', async () => {
            try {
                let inputText = '';
                
                if (currentMode === 'response') {
                    inputText = responseInput.value.trim();
                    currentUserMessage = inputText;
                    if (!inputText && uploadedFiles.length === 0) {
                        showCustomDialog('è¯·è¾“å…¥éœ€è¦å›åº”çš„æ–‡å­—æˆ–ä¸Šä¼ æ–‡ä»¶');
                        return;
                    }
                } else if (currentMode === 'refine') {
                    inputText = refineInput.value.trim();
                    currentUserMessage = inputText;
                    if (!inputText) {
                        showCustomDialog('è¯·è¾“å…¥éœ€è¦æ¶¦è‰²çš„æ–‡å­—');
                        return;
                    }
                }

                // ç¦ç”¨ç”ŸæˆæŒ‰é’®
                generateBtn.disabled = true;
                
                // æ˜¾ç¤ºç»“æœåŒºåŸŸï¼Œéšè—ç©ºçŠ¶æ€
                emptyState.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                loadingIndicator.classList.remove('hidden');
                resultTabs.classList.add('hidden');
                singleResultPanel.classList.add('hidden');
                saveToHistoryBtn.classList.add('hidden');
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                singleOutput.innerHTML = '';
                supportiveOutput.innerHTML = '';
                neutralOutput.innerHTML = '';
                cautionaryOutput.innerHTML = '';
                currentResponse = null;
                
                // è·å–ç”¨æˆ·é€‰æ‹©çš„ç«‹åœº
                let selectedStance = 'neutral';
                if (currentMode === 'response') {
                    selectedStance = document.querySelector('input[name="stance"]:checked').value;
                }
                
                // ç¡®å®šæ˜¯å¦éœ€è¦ç”Ÿæˆå¤šç‰ˆæœ¬å›å¤
                const isMultipleVersion = currentMode === 'response' && selectedStance === 'multiple';
                
                if (isMultipleVersion) {
                    resultTitle.textContent = 'Bransonè€å¸ˆçš„å›å¤ç‰ˆæœ¬';
                    loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆä¸‰ä¸ªç‰ˆæœ¬çš„å›å¤...';
                    
                    try {
                        await generateMultipleResponses(inputText, false);
                        loadingIndicator.classList.add('hidden');
                        resultTabs.classList.remove('hidden');
                        saveToHistoryBtn.classList.remove('hidden');
                        switchTab('supportive');
                    } catch (error) {
                        loadingIndicator.classList.add('hidden');
                        showCustomDialog(`ç”Ÿæˆå¤šç‰ˆæœ¬å›å¤å¤±è´¥: ${error.message}`);
                        console.error(error);
                    }
                } else {
                    resultTitle.textContent = currentMode === 'refine' ? 'Bransonè€å¸ˆé£æ ¼æ¶¦è‰²ç»“æœ' : 'Bransonè€å¸ˆçš„å›å¤';
                    loadingText.textContent = currentMode === 'refine' ? 'æ­£åœ¨æ¶¦è‰²æ–‡æœ¬...' : 'æ­£åœ¨ç”Ÿæˆå›å¤...';
                    
                    try {
                        await generateSingleResponse(inputText, false, selectedStance);
                        loadingIndicator.classList.add('hidden');
                        singleResultPanel.classList.remove('hidden');
                        saveToHistoryBtn.classList.remove('hidden');
                    } catch (error) {
                        loadingIndicator.classList.add('hidden');
                        singleOutput.innerHTML = `<p class="text-red-500">é”™è¯¯: ${error.message || 'ç”Ÿæˆå›å¤æ—¶å‡ºé”™'}</p>`;
                        singleResultPanel.classList.remove('hidden');
                        console.error(error);
                    }
                }
                
            } catch (error) {
                loadingIndicator.classList.add('hidden');
                showCustomDialog(`å‘ç”Ÿé”™è¯¯: ${error.message}`);
                console.error("Error:", error);
            } finally {
                // é‡æ–°å¯ç”¨ç”ŸæˆæŒ‰é’®
                generateBtn.disabled = false;
            }
        });

        resetBtn.addEventListener('click', () => {
            responseInput.value = '';
            refineInput.value = '';
            followUpInput.value = '';
        });
        
        // åˆå§‹åŒ–è¿½é—®çŠ¶æ€
        updateFollowUpState();
    </script>
</body>
</html>
